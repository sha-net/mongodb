var MongoClient = require('mongodb').MongoClient
	, format = require('util').format
	, config = require('./config')
	, express = require('express')
	, app = express();    

/*app.set('view engine', 'ejs');
app.engine('html', require('ejs').renderFile);

app.get('/', function (req, res)
{
    res.render('index.html',{title:'My Title',body:'My Body'});
});
app.listen(80);
console.log('Listening on port 80');
*/

MongoClient.connect('mongodb://mongo-shard-shavit-333065997.us-east-1.elb.amazonaws.com:27017/mydb', function(err, db) {
 if(err) throw err;

 var collection = db.collection('zip');
 collection.insert({a:2}, function(err, docs) {

  var map = function(){
   if(this.country && this.city && this.updated == "2010-07-22 20:00:20"){
   
    //emit(this.country,{votes:1});
    emit(this.country,this.city);
   }
  }
  
  var reduce = function(key, values){
   var reducedObject = {
    city: "",
    total: 0
   };
   
   if(values.length){
    values.forEach(function(value){
     reducedObject.city += value + ", ";
     reducedObject.total += 1;
    });
   }
   return reducedObject;
  };

  collection.mapReduce(
   map,
   reduce,
   {
    
    out: 'map_reduce_collection'
   }
   , function (err, collection, stats){            
    if( err ) {
     console.log('Map reduce: Fail.');        
    }
    else {      
     console.log('Map reduce: Success.');
    }
    db.close();
   });
}});

